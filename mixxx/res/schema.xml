<?xml version="1.0" encoding="utf-8"?>
<!--
This is the Mixxx schema history file. It keeps track of internal changes to the
Mixxx database schema and allows Mixxx to automatically upgrade itself to new
revisions of the schema on a version upgrade.

DO NOT EDIT THIS FILE OR YOU WILL BREAK YOUR MIXXX LIBRARY AND LOSE YOUR
METADATA
-->
<schema>
  <revision version="1">
    <description>
      The base schema for the Mixxx SQLITE database.
    </description>
    <sql>
      CREATE TABLE IF NOT EXISTS settings (
        name TEXT UNIQUE NOT NULL,
        value TEXT,
        locked INTEGER DEFAULT 0,
        hidden INTEGER DEFAULT 0);

      CREATE TABLE IF NOT EXISTS track_locations (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        location varchar(512) UNIQUE,
        filename varchar(512),
        directory varchar(512),
        filesize INTEGER,
        fs_deleted INTEGER,
        needs_verification INTEGER);

      CREATE TABLE IF NOT EXISTS LibraryHashes (
        directory_path VARCHAR(256) primary key,
        hash INTEGER,
        directory_deleted INTEGER);

      CREATE TABLE IF NOT EXISTS library (
        id INTEGER primary key AUTOINCREMENT,
        artist varchar(48), title varchar(48),
        album varchar(48), year varchar(16),
        genre varchar(32), tracknumber varchar(3),
        location varchar(512) REFERENCES track_locations(location),
        comment varchar(20), url varchar(256),
        duration integer,
        bitrate integer, samplerate integer,
        cuepoint integer, bpm float,
        wavesummaryhex blob,
        channels integer,
        datetime_added DEFAULT CURRENT_TIMESTAMP,
        mixxx_deleted integer,
        played integer);

      CREATE TABLE Playlists (
        id INTEGER primary key,
        name varchar(48),
        position INTEGER,
        hidden INTEGER DEFAULT 0 NOT NULL,
        date_created datetime,
        date_modified datetime);

      CREATE TABLE PlaylistTracks (
        id INTEGER primary key,
        playlist_id INTEGER REFERENCES Playlists(id),
        track_id INTEGER REFERENCES library(id),
        position INTEGER);

      CREATE TABLE IF NOT EXISTS cues (
        id integer PRIMARY KEY AUTOINCREMENT,
        track_id integer NOT NULL REFERENCES library(id),
        type integer DEFAULT 0 NOT NULL,
        position integer DEFAULT -1 NOT NULL,
        length integer DEFAULT 0 NOT NULL,
        hotcue integer DEFAULT -1 NOT NULL,
        label text DEFAULT '' NOT NULL);

      CREATE TABLE IF NOT EXISTS crates (
        id integer PRIMARY KEY AUTOINCREMENT,
        name varchar(48) UNIQUE NOT NULL,
        count integer DEFAULT 0,
        show integer DEFAULT 1);

      CREATE TABLE IF NOT EXISTS crate_tracks (
        crate_id integer NOT NULL REFERENCES crates(id),
        track_id integer NOT NULL REFERENCES library(id),
        UNIQUE (crate_id, track_id));

    </sql>
  </revision>
  <revision version="2">
    <description>
      Add a header_parsed integer column to the library to indicate when a
      track's tags have been parsed.
    </description>
    <sql>
      ALTER TABLE library ADD COLUMN header_parsed integer DEFAULT 0;
    </sql>
  </revision>
  <revision version="3">
    <description>
      Change the location column to be a an integer. Change comment to be
      varchar(256) and album/artist/title to be varchar(64).
    </description>
    <sql>
      ALTER TABLE library RENAME TO library_old;

      CREATE TABLE IF NOT EXISTS library (
        id INTEGER primary key AUTOINCREMENT,
        artist varchar(64),
        title varchar(64),
        album varchar(64),
        year varchar(16),
        genre varchar(64),
        tracknumber varchar(3),
        location integer REFERENCES track_locations(location),
        comment varchar(256),
        url varchar(256),
        duration integer,
        bitrate integer,
        samplerate integer,
        cuepoint integer,
        bpm float,
        wavesummaryhex blob,
        channels integer,
        datetime_added DEFAULT CURRENT_TIMESTAMP,
        mixxx_deleted integer,
        played integer,
        header_parsed integer DEFAULT 0);

      INSERT INTO library (id, artist, title, album, year, genre, tracknumber, location, comment, url, duration, bitrate, samplerate, bpm, cuepoint, bpm, wavesummaryhex, channels, datetime_added, mixxx_deleted, played, header_parsed) SELECT id, artist, title, album, year, genre, tracknumber, location, comment, url, duration, bitrate, samplerate, bpm, cuepoint, bpm, wavesummaryhex, channels, datetime_added, mixxx_deleted, played, header_parsed from library_old;

      DROP TABLE library_old;
    </sql>
  </revision>
  <revision version="4">
    <description>
      Add file type column.
    </description>
    <sql>
      ALTER TABLE library ADD COLUMN filetype varchar(8) DEFAULT "?";
    </sql>
  </revision>
  <revision version="5">
   <description>
      Add needs_verification column to library hashes table.
    </description>
    <sql>
      ALTER TABLE LibraryHashes ADD COLUMN needs_verification INTEGER DEFAULT 0;
    </sql>
  </revision>
  <revision version="6">
  	<description>
  		Add timesplayed column
  	</description>
  	<sql>
  		ALTER TABLE library ADD COLUMN timesplayed integer DEFAULT 0;
  		
  		UPDATE library SET timesplayed = played;
  		UPDATE library SET played = 0;
  		DELETE FROM settings WHERE name="mixxx.db.model.library.header_state";
  		DELETE FROM settings WHERE name="mixxx.db.model.crate.header_state";
  	</sql>
  </revision>
</schema>
